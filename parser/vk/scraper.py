import os
import time
import re
import vk_api
import pandas as pd
from datetime import datetime, timedelta
from dotenv import load_dotenv

load_dotenv()
VK_TOKEN = os.getenv("VK_TOKEN")

if not VK_TOKEN:
    print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")
    exit()

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê –û–°–ù–û–í–ï –¢–í–û–ï–ì–û –ü–†–û–ú–¢–ê ---

# 1. –ó–ê–ü–†–û–°–´ –î–õ–Ø –ü–û–ò–°–ö–ê –ì–†–£–ü–ü (–ò—Å–ø–æ–ª—å–∑—É–µ–º "–ü—Ä—è–º—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é" –∏–∑ –ø—Ä–æ–º—Ç–∞)
# –≠—Ç–æ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –º—ã –∏—â–µ–º –°–ê–ú–ò –°–û–û–ë–©–ï–°–¢–í–ê
GROUP_SEARCH_QUERIES = [
    '–†–∞–±–æ—á–∏–π –¥–æ–º', 
    '–†–∞–±–æ—á–∏–π –¥–æ–º —Ä–∞–±–æ—Ç–∞',
    '–¢—Ä—É–¥–æ–≤–æ–π –ø—Ä–∏—é—Ç',
    '–î–æ–º —Ç—Ä—É–¥–æ–ª—é–±–∏—è',
    '–¶–µ–Ω—Ç—Ä —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏',
    '–†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ–º –∏ –ø–∏—Ç–∞–Ω–∏–µ–º',
    '–ü–æ–º–æ—â—å –±–µ–∑–¥–æ–º–Ω—ã–º',
    '–ü—Ä–∏—é—Ç –¥–ª—è —Ä–∞–±–æ—á–∏—Ö'
]

# 2. –§–ò–õ–¨–¢–† –ù–ê–ó–í–ê–ù–ò–ô –ì–†–£–ü–ü (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫)
# –û—Ç—Å–µ–∫–∞–µ–º –∑–æ–æ–∑–∞—â–∏—Ç—É –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø
BANNED_GROUP_WORDS = [
    '–∂–∏–≤–æ—Ç–Ω', '—Ö–≤–æ—Å—Ç', '–ª–∞–ø', '–∫–æ—Ç', '–ø–µ—Å', '—Å–æ–±–∞–∫', '–∑–≤–µ—Ä', 
    '–ø–∏—Ç–æ–º', '—â–µ–Ω', '–ø–æ—Ç–µ—Ä—è—à', '–∑–æ–æ', 'help_dog'
]

# 3. –§–ò–õ–¨–¢–† –¢–ï–ö–°–¢–ê –ü–û–°–¢–ê (–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫)
# –û—Ç—Å–µ–∫–∞–µ–º –º—É—Å–æ—Ä –≤–Ω—É—Ç—Ä–∏ –ø–æ—Å—Ç–æ–≤ (–∂–∏–≤–æ—Ç–Ω—ã–µ + –±–µ–ª–∞—è —Ä–∞–±–æ—Ç–∞)
STOP_WORDS_IN_POST = [
    # –ñ–∏–≤–æ—Ç–Ω—ã–µ (–∏–∑ –ø—Ä–æ–º—Ç–∞)
    '–∫–æ—à–∫–∞', '—Å–æ–±–∞–∫–∞', '—â–µ–Ω–æ–∫', '–∫–æ—Ç–µ–Ω–æ–∫', '—Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è', '–ø—Ä–∏–≤–∏–≤–∫–∏', 
    '–ø–µ—Ä–µ–¥–µ—Ä–∂–∫–∞', '–ø–æ—Ä–æ–¥–∞', '–≤–µ—Ç–∫–ª–∏–Ω–∏–∫–∞', '–∫–æ—Ä–º', '–∫—É—Ä–∞—Ç–æ—Ä', '–ª–∞—Å–∫–æ–≤–∞—è',
    # "–ë–µ–ª–∞—è" —Ä–∞–±–æ—Ç–∞ –∏ –æ—Ñ–∏—Å—ã
    '—Ä–µ–∑—é–º–µ', '–≤—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', '–∑–Ω–∞–Ω–∏–µ –ø–∫', '–∏–Ω–∂–µ–Ω–µ—Ä', '–¥–∏–∑–∞–π–Ω–µ—Ä', 
    '–º–µ–Ω–µ–¥–∂–µ—Ä', '–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', '—Ç–∫ —Ä—Ñ', '—É–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞',
    '—Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã', '–±–∞—Ä–∏—Å—Ç–∞'
]

# 4. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ú–ê–†–ö–ï–†–´ (–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫)
# –ü–æ—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ü–µ–ª–µ–≤—ã–º, –µ—Å–ª–∏ –≤ –Ω–µ–º –µ—Å—Ç—å —Å–ª–æ–≤–∞ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–£—Å–ª–æ–≤–∏—è" –∏–ª–∏ "–ê—É–¥–∏—Ç–æ—Ä–∏—è"
REQUIRED_CONTEXT_WORDS = [
    # –£—Å–ª–æ–≤–∏—è (–∏–∑ –ø—Ä–æ–º—Ç–∞)
    '–ø–∏—Ç–∞–Ω–∏–µ', '–ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ', '–∫–æ–π–∫–æ', '–µ–∂–µ–¥–Ω–µ–≤–Ω', '–≤—ã–ø–ª–∞—Ç', '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ', 
    '–¥–æ–∫—É–º–µ–Ω—Ç', '–±–∏–ª–µ—Ç', '–≤–∞—Ö—Ç–∞', '–∂–∏–ª—å—ë', 
    # –ê—É–¥–∏—Ç–æ—Ä–∏—è
    '–∑–∞–≤–∏—Å–∏–º', '–∞–ª–∫–æ', '–Ω–∞—Ä–∫–æ', '–∞–¥–∞–ø—Ç–∞—Ü', '—Ç—Ä—É–¥–Ω', '—Å–∏—Ç—É–∞—Ü', '–±–µ–∑–¥–æ–º–Ω'
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞
GROUPS_LIMIT_PER_QUERY = 30   # –°–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
POSTS_PER_GROUP = 50          # –ì–ª—É–±–∏–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–µ–Ω—ã
DAYS_TO_CHECK = 365           # –ë—Ä–∞—Ç—å –ø–æ—Å—Ç—ã –Ω–µ —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 6-12 –º–µ—Å)

def get_phone(text):
    if not text: return None
    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π regex –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –†–§
    pattern = r'(?:\+7|8|7)[\s\-]?\(?(\d{3})\)?[\s\-]?(\d{3})[\s\-]?(\d{2})[\s\-]?(\d{2})'
    match = re.search(pattern, text)
    if match:
        return match.group(0)
    return None

def is_group_name_clean(name):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–∞ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ (–∑–æ–æ–∑–∞—â–∏—Ç–∞)"""
    name_lower = name.lower()
    for bad_word in BANNED_GROUP_WORDS:
        if bad_word in name_lower:
            return False
    return True

def is_post_relevant(text):
    """
    –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞ –ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ.
    1. –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–æ–ø-—Å–ª–æ–≤.
    2. –°–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä–∫–µ—Ä—ã —Ä–∞–±–æ—á–µ–≥–æ –¥–æ–º–∞.
    """
    text_lower = text.lower()
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –°–¢–û–ü-–°–õ–û–í–ê
    for bad_word in STOP_WORDS_IN_POST:
        if bad_word in text_lower:
            return False 

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –°–õ–û–í–ê
    has_required = False
    for good_word in REQUIRED_CONTEXT_WORDS:
        if good_word in text_lower:
            has_required = True
            break
    
    if not has_required:
        return False

    return True

def main():
    print("üöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ (–≤–µ—Ä—Å–∏—è –ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ)...")
    
    try:
        vk_session = vk_api.VkApi(token=VK_TOKEN)
        vk = vk_session.get_api()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: {e}")
        return

    # --- –®–ê–ì 1: –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥—Ä—É–ø–ø ---
    target_groups = []
    seen_group_ids = set()
    
    print("üîé –ò—â–µ–º —Ü–µ–ª–µ–≤—ã–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞...")
    
    for query in GROUP_SEARCH_QUERIES:
        try:
            # –ò—â–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
            groups = vk.groups.search(q=query, count=GROUPS_LIMIT_PER_QUERY, sort=0)['items']
            
            for g in groups:
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–∫—Ä—ã—Ç—ã–µ –∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
                if g['is_closed'] == 1 or g['id'] in seen_group_ids:
                    continue

                # –§–ò–õ–¨–¢–† –ü–û –ù–ê–ó–í–ê–ù–ò–Æ (–£–±–∏—Ä–∞–µ–º "–•–≤–æ—Å—Ç–∏–∫–æ–≤")
                if not is_group_name_clean(g['name']):
                    continue

                seen_group_ids.add(g['id'])
                target_groups.append({
                    'id': g['id'],
                    'name': g['name'],
                    'screen_name': g['screen_name']
                })
                
            time.sleep(0.3)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø '{query}': {e}")

    print(f"üéØ –û—Ç–æ–±—Ä–∞–Ω–æ {len(target_groups)} –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.")

    # --- –®–ê–ì 2: –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç–µ–Ω ---
    all_posts = []
    min_date = datetime.now() - timedelta(days=DAYS_TO_CHECK)
    
    print(f"üì• –°–∫–∞–Ω–∏—Ä—É–µ–º —Å—Ç–µ–Ω—ã (–≥–ª—É–±–∏–Ω–∞ {POSTS_PER_GROUP} –ø–æ—Å—Ç–æ–≤, –Ω–µ —Å—Ç–∞—Ä—à–µ {min_date.date()})...")
    
    for idx, group in enumerate(target_groups):
        print(f"[{idx+1}/{len(target_groups)}] {group['name']}...", end='\r')
        
        try:
            posts = vk.wall.get(owner_id=f"-{group['id']}", count=POSTS_PER_GROUP)['items']
            
            for post in posts:
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã
                post_date = datetime.fromtimestamp(post['date'])
                if post_date < min_date:
                    continue

                # --- –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –¢–ï–ö–°–¢–ê (–≤–∫–ª—é—á–∞—è —Ä–µ–ø–æ—Å—Ç—ã) ---
                text = post.get('text', '')
                is_repost = False
                
                # –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–ø–æ—Å—Ç, –±–µ—Ä–µ–º —Ç–µ–∫—Å—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
                if 'copy_history' in post and len(post['copy_history']) > 0:
                    repost_text = post['copy_history'][0].get('text', '')
                    text = f"{text}\n--- REPOST ---\n{repost_text}"
                    is_repost = True
                
                if not text: continue
                
                # --- –ì–õ–ê–í–ù–´–ï –§–ò–õ–¨–¢–†–´ ---
                # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (–£–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä, –∏—â–µ–º –∫–ª—é—á–µ–≤–∏–∫–∏)
                if not is_post_relevant(text):
                    continue

                # 2. –ò—â–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ, —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –±–∞–∑—ã)
                phone = get_phone(text)
                
                # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ò —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π/–ø—É—Å—Ç–æ–π -> –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                # (–ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ —Ä–µ–∫–ª–∞–º–∞ –∞–¥—Ä–µ—Å–∞, –±–µ—Ä–µ–º)
                if not phone and len(text) < 50:
                    continue

                all_posts.append({
                    'group_name': group['name'],
                    'date': post_date.strftime('%Y-%m-%d'),
                    'phone': phone,
                    'is_repost': 1 if is_repost else 0,
                    'city': '?', 
                    'link': f"https://vk.com/wall-{group['id']}_{post['id']}",
                    'text_preview': text[:500].replace('\n', ' ') # –û–±—Ä–µ–∑–∞–µ–º –¥–ª—è Excel
                })
            
            time.sleep(0.3) 

        except Exception as e:
            # print(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–µ–Ω–µ {group['id']}") 
            pass

    # --- –®–ê–ì 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ---
    print("\n") 
    if all_posts:
        df = pd.DataFrame(all_posts)
        # –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ —Ç–µ–∫—Å—Ç—É
        df = df.drop_duplicates(subset=['text_preview'])
        
        filename = f"working_houses_filtered_{datetime.now().strftime('%d_%H%M')}.xlsx"
        df.to_excel(filename, index=False)
        print(f"‚úÖ –£–°–ü–ï–•! –°–æ–±—Ä–∞–Ω–æ {len(df)} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.")
        print(f"–§–∞–π–ª: {filename}")
    else:
        print("üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π —É–≤–µ–ª–∏—á–∏—Ç—å DAYS_TO_CHECK –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø.")

if __name__ == "__main__":
    main()